!function(){"use strict";function a(a){this.viewer=a,this.geometryItem=null,this.mappingPromise=null,this.filter={seedURN:!0,objectSet:!0,viewport:!0,tags:!0,renderOptions:!1,cutplanes:!0}}function b(a){for(var b={},c=[],d=a.length,e=0,f=0;d>f;f++){var g=a[f];1!==b[g]&&(b[g]=1,c[e++]=g)}return c}var c=AutodeskNamespace("Autodesk.Viewing.Comments"),d=a.prototype;d.destroy=function(){this.viewer=null,this.geometryItem=null},d.createCommentObj=function(a){var b=this.viewer.getState(this.filter);return this.injectInfo(b,a),b},d.injectInfo=function(a,b){if(a.body=b.message||"",a.status="open",a.jsonVersion="2.0",a.inputSource="Web",a.type="geometry",this.geometryItem&&(a.layoutName=this.geometryItem.guid,a.layoutIndex=this.geometryItem.order),b.point3d){var c=b.point3d;c instanceof THREE.Vector3&&(c=c.toArray()),this.pushTag(a,{name:"nodeOffset",value:c})}},d.pushTag=function(a,b){Array.isArray(a.tags)||(a.tags=[]),a.tags.push(b)},d.getTag=function(a,b){var c=a.tags;if(c&&Array.isArray(c))for(var d=0,e=c.length;e>d;++d)if(c[d].name===b)return c[d];return null},d.getTagValue=function(a,b,c){var d=this.getTag(a,b);return d?d.value:c||null},d.exportCommentObj=function(a){var b=this;return new Promise(function(c){b.applyGlobalOffset(a),b.getMappingPromise().then(function(d){b.mapObjectSetLmvToExternal(a,d,function(a){c(a)})})})},d.importCommentObj=function(a){var b={};for(var c in this.filter)this.filter.hasOwnProperty(c)&&a.hasOwnProperty(c)&&(b[c]=a[c]);var d=JSON.parse(JSON.stringify(b)),e=this;return new Promise(function(a){e.getMappingPromise().then(function(b){e.mapObjectSetExternalToLmv(d,b),e.removeGlobalOffset(d),a(d)})})},d.applyGlobalOffset=function(a){var b=this.viewer.model.getData().globalOffset;if(b){this.applyOffsetToCamera(a.viewport,b);var c=this.getTag(a,"nodeOffset");return c&&this.applyOffset(c.value,b),!0}return!1},d.removeGlobalOffset=function(a){var b=this.viewer.model.getData().globalOffset;if(b){var c={x:-b.x,y:-b.y,z:-b.z};this.applyOffsetToCamera(a.viewport,c);var d=this.getTag(a,"nodeOffset");return d&&this.applyOffset(d.value,c),!0}return!1},d.applyOffsetToCamera=function(a,b){a&&b&&(this.applyOffset(a.eye,b),this.applyOffset(a.target,b),this.applyOffset(a.pivotPoint,b))},d.applyOffset=function(a,b){if(a){var c=Number(a[0])+b.x,d=Number(a[1])+b.y,e=Number(a[2])+b.z;a[0]="string"==typeof a[0]?c.toString():c,a[1]="string"==typeof a[1]?d.toString():d,a[2]="string"==typeof a[2]?e.toString():e}},d.mapObjectSetLmvToExternal=function(a,c,d){c||d(a),this.viewer.model.is2d()&&d(a);var e=this.getObjectSetElementWithIdType(a.objectSet,"lmv"),f=[].concat(e.id).concat(e.hidden).concat(e.isolated);b(f),this.viewer.model.getBulkProperties(f,["externalId"],function(b){var c={};b.forEach(function(a){c[a.dbId]=a.externalId});var f=JSON.parse(JSON.stringify(e));f.idType="external";var g=function(a){return c[a]};f.id=f.id.map(g),f.hidden=f.hidden.map(g),f.isolated=f.isolated.map(g),a.objectSet.push(f),d(a)},function(){d(a)})},d.mapObjectSetExternalToLmv=function(a,b){if(b){var c=a.objectSet,d=this.getObjectSetElementWithIdType(c,"lmv");if(!d){var e=this.getObjectSetElementWithIdType(c,"external");if(e){var f=function(a){return b[a]},g=JSON.parse(JSON.stringify(e));g.id=g.id.map(f),g.isolated=g.isolated.map(f),g.hidden=g.hidden.map(f),g.idType="lmv",c.unshift(g)}}}},d.getObjectSetElementWithIdType=function(a,b){if(!a||!Array.isArray(a))return null;for(var c=0,d=a.length;d>c;++c)if(a[c].idType===b)return a[c];return null},d.getMappingPromise=function(){if(!this.mappingPromise){var a=this;this.mappingPromise=new Promise(function(b){a.viewer.model.getExternalIdMapping(function(a){stderr("[Autodesk.Comment]Successfully fetched external id mapping."),b(a)},function(){stderr("[Autodesk.Comment]Failed to fetch the external id mapping."),b(null)})})}return this.mappingPromise},c.CommentFactory=a}(),function(){"use strict";function a(a){this.viewer=a,this.PATH_STORAGE=null,this.CREDENTIALS={OAUTH_2_TOKEN:null},this.fakeRequest=null}function b(a,b,c,d,e,f){if(a.fakeRequest)return a.fakeRequest.createRequest(b,c,e,f);var g=new XMLHttpRequest;return g.open(b,c,!0),d&&g.setRequestHeader("Content-Type",d),g.setRequestHeader("Access-Control-Allow-Origin","*"),g.setRequestHeader("Authorization","Bearer "+a.CREDENTIALS.OAUTH_2_TOKEN),g.onload=e.onLoad,g.onerror=e.onError,g.ontimeout=e.onTimeout,g}function c(a,b,c){return{onLoad:function(d){200==d.currentTarget.status?a(c?d.currentTarget.response:d.currentTarget.responseText):b()},onError:function(){b()},onTimeout:function(){b()}}}function d(a,b){b&&b.forEach(function(b){a.setRequestHeader(b.name,b.value)})}function e(a){return window.btoa?window.btoa(a):window.Base64.encode(a)}var f=AutodeskNamespace("Autodesk.Viewing.Comments"),g=a.prototype;g.ENV_TABLE={Local:{COMMENT:"https://developer-dev.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-dev.api.autodesk.com/oss/v1/"},Development:{COMMENT:"https://developer-dev.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-dev.api.autodesk.com/oss/v1/"},Staging:{COMMENT:"https://developer-stg.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-stg.api.autodesk.com/oss/v1/"},Production:{COMMENT:"https://developer.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer.api.autodesk.com/oss/v1/"},AutodeskDevelopment:{COMMENT:"https://developer-dev.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-dev.api.autodesk.com/oss/v1/"},AutodeskStaging:{COMMENT:"https://developer-stg.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer-stg.api.autodesk.com/oss/v1/"},AutodeskProduction:{COMMENT:"https://developer.api.autodesk.com/comments/v2/",OBJECT_STORAGE:"https://developer.api.autodesk.com/oss/v1/"}},g.init=function(a){a=a||{},this.env=Autodesk.Viewing.Private.env,a.fakeServer&&(this.fakeRequest=new f.FakeRequest(a));var b=this.ENV_TABLE[this.env];if(this.COMMENT_SERVICE_URL=b.COMMENT,this.OBJECT_STORAGE_SERVICE_URL=b.OBJECT_STORAGE,!a.fakeServer&&!a.oauth2token)return console.warn("[CommentExt]options.oauth2token not found; failed to initialized extension."),!1;if(this.setToken(a.oauth2token),!a.fakeServer&&!a.urn){var c=this.viewer.model;if(c&&c.loader&&(a.urn=c.loader.svfUrn,stderr("[CommentExt]options.urn not found; auto-detecting: "+a.urn)),!a.urn)return console.warn("[CommentExt]options.urn not found; failed to initialized extension."),!1}return this.setPathStorage(a.urn),!0},g.destroy=function(){this.viewer=null,this.fakeRequest=null},g.setToken=function(a){this.CREDENTIALS.OAUTH_2_TOKEN=a},g.setPathStorage=function(a){this.PATH_STORAGE=a},g.listComments=function(a){var e=this;return new Promise(function(f,g){var h=[e.COMMENT_SERVICE_URL,"resources/",e.PATH_STORAGE].join(""),i=c(f,g),j=b(e,"GET",h,"text/plain",i);d(j,a),j.send()})},g.postComment=function(a,e){var f=this;return new Promise(function(g,h){var i=[f.COMMENT_SERVICE_URL,"resources/",f.PATH_STORAGE].join(""),j=c(g,h),k=b(f,"POST",i,"text/plain",j);d(k,e),k.send(JSON.stringify(a))})},g.postCommentReply=function(a,f,g){var h=this;return new Promise(function(i,j){var k=window.encodeURIComponent(e(f)),l=[h.COMMENT_SERVICE_URL,"resources/",k].join(""),m=c(i,j),n=b(h,"POST",l,"text/plain",m);d(n,g),n.send(JSON.stringify(a))})},g.deleteComment=function(a,f){var g=this;return new Promise(function(h,i){var j=e(a),k=window.encodeURIComponent(j),l=[g.COMMENT_SERVICE_URL,"resources/",k].join(""),m=c(h,i),n=b(g,"DELETE",l,"text/plain",m);d(n,f),n.send()})},g.fetchLocationForNewOssAttachment=function(a,c){var e=[this.COMMENT_SERVICE_URL,"resources/",this.PATH_STORAGE,"/attachment"].join(""),f=b(this,"POST",e,"application/json",c,"fetchLocationForNewOssAttachment");d(f,a),f.send()},g.getAttachment=function(a,e,f){var g=this;return new Promise(function(h,i){var j=g.extractOssBucketAndId(a),k=[g.OBJECT_STORAGE_SERVICE_URL,"buckets/",j[0],"/objects/",j[1]].join(""),l=c(h,i,e),m=b(g,"GET",k,null,l);d(m,f),e&&(m.responseType="arraybuffer"),m.send()})},g.postAttachment=function(a,c,e,f,g){var h=[this.OBJECT_STORAGE_SERVICE_URL,"buckets/",e,"/objects/",a].join(""),i=b(this,"PUT",h,"text/plain",g);d(i,f),i.send(c)},g.deleteAttachment=function(a,c,d){var e=[this.OBJECT_STORAGE_SERVICE_URL,"buckets/",c,"/objects/",a].join(""),f=b(this,"DELETE",e,"text/plain",d);f.send()},g.extractOssBucketAndId=function(a){var b=a.split("/"),c=b[0],d=c.split(":");return b[0]=d[d.length-1],b},f.CommentService=a}(),function(){"use strict";function a(a,b){Autodesk.Viewing.Extension.call(this,a,b)}var b="Autodesk.Comments",c=AutodeskNamespace("Autodesk.Viewing.Comments");a.prototype=Object.create(Autodesk.Viewing.Extension.prototype),a.prototype.constructor=a;var d=a.prototype;d.load=function(){try{new Promise(function(a,b){})}catch(a){return!1}return this.factory=new c.CommentFactory(this.viewer),this.commentService=new c.CommentService(this.viewer),this.commentService.init(this.options)},d.unload=function(){return this.commentService&&(this.commentService.destroy(),this.commentService=null),this.factory&&(this.factory.destroy(),this.factory=null),!0},a.prototype.setGeometryItem=function(a){this.factory.geometryItem=a},a.prototype.createComment=function(a){var b=a||{};"string"==typeof a&&(b={message:a});var c=this.factory.createCommentObj(b);return this.factory.exportCommentObj(c)},a.prototype.restoreComment=function(a,b,c){var d=this;return new Promise(function(e){var f=d.factory.importCommentObj(a);f.then(function(a){d.viewer.restoreState(a,b,c),e(a)})})},a.prototype.setToken=function(a){this.commentService.setToken(a)},a.prototype.setPathStorage=function(a){if(!a)throw new Error(b+": Invalid path storage");this.commentService.setPathStorage(a)},a.prototype.getComments=function(){return this.commentService.listComments()},a.prototype.postComment=function(a,b){return this.commentService.postComment(a,b)},a.prototype.postCommentReply=function(a,b){return this.commentService.postCommentReply(a,b)},a.prototype.deleteComment=function(a){return this.commentService.deleteComment(a)},a.prototype.deleteCommentReply=function(a){return this.deleteComment(a)},a.prototype.fetchLocationForNewOssAttachment=function(a,b){return this.commentService.fetchLocationForNewOssAttachment(a,b)},a.prototype.extractOssBucketAndId=function(a){return this.commentService.extractOssBucketAndId(a)},a.prototype.postAttachment=function(a,b,c,d,e){return this.commentService.postAttachment(a,b,c,d,e)},a.prototype.getAttachment=function(a,b,c){return this.commentService.getAttachment(a,b,c)},Autodesk.Viewing.theExtensionManager.registerExtension(b,a),c.CommentsExtension=a}(),function(){"use strict";function a(a){this.options=a||{},this.FAKE_SERVER_DELAY=this.options.fakeSeverDelay||200,this.FAKE_NEXT_ID=11}var b=AutodeskNamespace("Autodesk.Viewing.Comments"),c=a.prototype;c.createRequest=function(a,b,c,d){var e=this,f={notifyCallback:function(a){e.FAKE_SERVER_DELAY?setTimeout(function(){c.onLoad(a)},e.FAKE_SERVER_DELAY):c.onLoad(a)},replyPostComment:function(a){var b=JSON.parse(a);b.id=e.FAKE_NEXT_ID++,b.index=b.id,b.layoutName=b.layoutName||"Another Sheet",b.actor||(b.actor={name:e.options.displayName||"John Doe",id:e.options.oxygenId||"ABCDEFGHIJK"}),b.published=(new Date).toUTCString(),this.notifyCallback({currentTarget:{status:200,responseText:JSON.stringify(b)}})},replyFetchLocationForNewOssAttachment:function(){var a={attachment:[{url:"urn:adsk.objects:os.object:comments/filename"}]};this.notifyCallback({currentTarget:{status:200,responseText:JSON.stringify(a)}})},send:function(b){switch(a){case"GET":this.notifyCallback({currentTarget:{status:200,responseText:"[]"}});break;case"POST":switch(d){case"fetchLocationForNewOssAttachment":this.replyFetchLocationForNewOssAttachment();break;default:this.replyPostComment(b)}break;case"DELETE":this.notifyCallback({currentTarget:{status:200,responseText:"{}"}});break;case"PUT":try{JSON.parse(b),this.notifyCallback({currentTarget:{status:200,responseText:b}})}catch(c){var e={objects:[{id:"test",key:"test","content-type":"image/png",location:"http://www.autodesk.com"}]};this.notifyCallback({currentTarget:{status:200,responseText:JSON.stringify(e)}})}}},setRequestHeader:function(){}};return f},b.FakeRequest=a}();